
[1m[46m RUN [49m[22m [36mv4.0.14 [39m[90mC:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend[39m

 [32m‚úì[39m test/errors.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32m‚úì[39m test/health.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 6[2mms[22m[39m
stderr | test/recaptcha.test.ts > Recaptcha Tests > verifyRecaptcha (Utility) > should throw Error if RECAPTCHA_V3_SECRET_KEY is missing (Fail Closed)
RECAPTCHA_V3_SECRET_KEY is not set.

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mverifyRecaptcha (Utility)[2m > [22m[2mshould return false if API returns success: false
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":false,"expected_action":"TEST","threshold":0.5,"error_codes":["invalid-input"]}}

stderr | test/recaptcha.test.ts > Recaptcha Tests > verifyRecaptcha (Utility) > should return false if API returns success: false
reCAPTCHA verification failed: [ 'invalid-input' ]

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mverifyRecaptcha (Utility)[2m > [22m[2mshould return false if action mismatch
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":true,"score":0.9,"action":"OTHER_ACTION","expected_action":"TEST","threshold":0.5}}

stderr | test/recaptcha.test.ts > Recaptcha Tests > verifyRecaptcha (Utility) > should return false if action mismatch
reCAPTCHA action mismatch: expected 'TEST', got 'OTHER_ACTION'

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mverifyRecaptcha (Utility)[2m > [22m[2mshould return false if score too low
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":true,"score":0.1,"action":"TEST","expected_action":"TEST","threshold":0.5}}

stderr | test/recaptcha.test.ts > Recaptcha Tests > verifyRecaptcha (Utility) > should return false if score too low
reCAPTCHA score too low: 0.1 < 0.5 (action: TEST)

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mverifyRecaptcha (Utility)[2m > [22m[2mshould return true if valid
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":true,"score":0.9,"action":"TEST","expected_action":"TEST","threshold":0.5}}

 [32m‚úì[39m test/firebaseRepository.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 8[2mms[22m[39m
[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mrecaptchaVerifier (HttpFunction)[2m > [22m[2mshould verify successfully with valid token and action
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":true,"score":0.9,"action":"AUTHENTICATE","expected_action":"AUTHENTICATE","threshold":0.3}}

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mrecaptchaVerifier (HttpFunction)[2m > [22m[2mshould use default threshold if action is missing/unknown
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":true,"score":0.4,"action":"","expected_action":"","threshold":0.3}}

[90mstdout[2m | test/recaptcha.test.ts[2m > [22m[2mRecaptcha Tests[2m > [22m[2mrecaptchaVerifier (HttpFunction)[2m > [22m[2mshould return success: false if verification fails
[22m[39m{"severity":"INFO","component":"recaptcha","token_verification":{"success":false,"expected_action":"AUTHENTICATE","threshold":0.3,"error_codes":["invalid-input-response"]}}

stderr | test/recaptcha.test.ts > Recaptcha Tests > recaptchaVerifier (HttpFunction) > should return success: false if verification fails
reCAPTCHA verification failed: [ 'invalid-input-response' ]

 [32m‚úì[39m test/recaptcha.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 17[2mms[22m[39m
stderr | test/oauth.test.ts > oauthHandler > should throw error if OAUTH_FITBIT_REDIRECT_URI is missing
Unhandled error in oauthHandler: Error: OAUTH_FITBIT_REDIRECT_URI Áí∞Â¢ÉÂ§âÊï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:154:13)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:66:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)

stderr | test/oauth.test.ts > oauthHandler > should throw error if FITBIT_CLIENT_ID or SECRET is missing
Unhandled error in oauthHandler: Error: FITBIT_CLIENT_ID and FITBIT_CLIENT_SECRET environment variables must be set
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:160:13)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:77:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)

stderr | test/oauth.test.ts > oauthHandler > should return 400 if state parameter is missing
Unhandled error in oauthHandler: ValidationError: Invalid request: state parameter is missing.
    at decodeState (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:66:11)
    at handleOAuthRequest (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:103:40)
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:167:13)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:89:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37 {
  statusCode: 400
}

stderr | test/oauth.test.ts > oauthHandler > should return 400 if state parameter is invalid base64/json
Unhandled error in oauthHandler: ValidationError: Invalid state: could not decode state parameter. Error: Unexpected token 'ÔøΩ', "ÔøΩ{⁄ñ'~mÔøΩÔøΩ" is not valid JSON
    at decodeState (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:77:11)
    at handleOAuthRequest (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:103:40)
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:167:13)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:100:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37 {
  statusCode: 400
}

stderr | test/oauth.test.ts > oauthHandler > should return 400 if firebaseUid is missing in state
Unhandled error in oauthHandler: ValidationError: Invalid state: Firebase UID is missing.
    at decodeState (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:83:11)
    at handleOAuthRequest (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:103:40)
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:167:13)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:114:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37 {
  statusCode: 400
}

stderr | test/oauth.test.ts > oauthHandler > should return 400 if redirectUri is invalid
Unhandled error in oauthHandler: ValidationError: Invalid redirect URI.
    at handleOAuthRequest (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:167:7)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:174:5
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:20 {
  statusCode: 400
}

stderr | test/oauth.test.ts > oauthHandler > should return 405 Method Not Allowed for non-GET/OPTIONS requests
Unhandled error in oauthHandler: MethodNotAllowedError: Method Not Allowed
    at Module.oauthHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/oauth.ts:171:11)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:184:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21) {
  statusCode: 405
}

stderr | test/oauth.test.ts > oauthHandler > should handle Unauthorized errors from exchangeCodeForTokens
Unhandled error in oauthHandler: Error: Unauthorized access
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:195:7
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)
    at runTest (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:12)

stderr | test/oauth.test.ts > oauthHandler > should handle arbitrary errors as 500
Unhandled error in oauthHandler: Error: Unknown error
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/oauth.test.ts:211:7
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)
    at runTest (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:12)

 [32m‚úì[39m test/oauth.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 18[2mms[22m[39m
 [32m‚úì[39m test/fitbitService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [31m‚ùØ[39m test/webhookHandler.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 21[2mms[22m[39m
     [32m‚úì[39m should throw error if FITBIT_REDIRECT_URI is not set[32m 2[2mms[22m[39m
     [32m‚úì[39m should handle OPTIONS request[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 200 OK for health check without code parameter[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should exchange code for tokens and redirect if state is valid and includes redirectUri[39m[32m 3[2mms[22m[39m
       [32m‚úì[39m should exchange code for tokens and send success message if state is valid but no redirectUri[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 400 if state parameter is missing[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 400 if state parameter cannot be decoded[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 400 if decoded state is not valid JSON[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 400 if firebaseUid is missing from decoded state[32m 1[2mms[22m[39m
       [32m‚úì[39m should handle error during exchangeCodeForTokens[32m 1[2mms[22m[39m
       [32m‚úì[39m should throw error if FITBIT_CLIENT_ID is not set[32m 0[2mms[22m[39m
       [32m‚úì[39m should throw error if FITBIT_CLIENT_SECRET is not set[32m 0[2mms[22m[39m
       [32m‚úì[39m should log foods successfully with valid token[32m 1[2mms[22m[39m
       [32m‚úì[39m should refresh token and log foods successfully if token is expired[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 401 if Authorization header is missing[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 401 if Authorization header is invalid[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 401 if verifyFirebaseIdToken fails[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 400 if nutritionData is missing[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 400 if nutritionData.foods is missing[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 400 if nutritionData.foods is not an array[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 401 if no tokens found for user[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 500 if refreshFitbitAccessToken fails[32m 1[2mms[22m[39m
       [32m‚úì[39m should return 500 if fitbitUserId is missing from tokens[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 500 if processAndLogFoods fails[32m 0[2mms[22m[39m
       [32m‚úì[39m should return 500 for unhandled errors[32m 0[2mms[22m[39m
     [32m‚úì[39m should return 405 for unsupported methods[32m 0[2mms[22m[39m
stderr | test/foodlog.test.ts > foodLogHandler > should return 405 for non-POST/OPTIONS requests
Unhandled error in foodLogHandler: MethodNotAllowedError: Method Not Allowed
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:135:11)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:82:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21) {
  statusCode: 405
}

stderr | test/foodlog.test.ts > foodLogHandler > should return 401 if Authorization header is missing
Unhandled error in foodLogHandler: AuthenticationError: Unauthorized: Authorization header is missing or invalid.
    at verifyAndGetFitbitToken (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:31:11)
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:105:51)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:88:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27) {
  statusCode: 401
}

stderr | test/foodlog.test.ts > foodLogHandler > should return 401 if Authorization header is invalid
Unhandled error in foodLogHandler: AuthenticationError: Unauthorized: Authorization header is missing or invalid.
    at verifyAndGetFitbitToken (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:31:11)
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:105:51)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:99:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27) {
  statusCode: 401
}

stderr | test/foodlog.test.ts > foodLogHandler > should return 401 if verifyFirebaseIdToken fails
Unhandled error in foodLogHandler: Error: Invalid ID token
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:106:7
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)
    at runTest (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:12)

stderr | test/foodlog.test.ts > foodLogHandler > should return 400 for invalid body (missing foods)
Unhandled error in foodLogHandler: ValidationError: Invalid JSON body. Required: a non-empty "foods" array.
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:116:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:131:5
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:20 {
  statusCode: 400
}

stderr | test/foodlog.test.ts > foodLogHandler > should return 400 for invalid body (foods is not array)
Unhandled error in foodLogHandler: ValidationError: Invalid JSON body. Required: a non-empty "foods" array.
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:116:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:152:5
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:20 {
  statusCode: 400
}

stderr | test/foodlog.test.ts > foodLogHandler > should return 401 if no tokens found for user
Unhandled error in foodLogHandler: AuthenticationError: No tokens found for user test-uid. Please complete the OAuth flow.
    at verifyAndGetFitbitToken (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:43:11)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:105:45)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:163:5
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:20 {
  statusCode: 401
}

[90mstdout[2m | test/foodlog.test.ts[2m > [22m[2mfoodLogHandler[2m > [22m[2mshould refresh token if expired
[22m[39mToken for user test-uid has expired. Refreshing...

stderr | test/foodlog.test.ts > foodLogHandler > should return 500 if fitbitUserId is missing
Unhandled error in foodLogHandler: FitbitApiError: Fitbit user ID not found in the database.
    at verifyAndGetFitbitToken (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:73:11)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Module.foodLogHandler (C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/src/handlers/foodlog.ts:105:45)
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:252:5
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:20 {
  statusCode: 500
}

stderr | test/foodlog.test.ts > foodLogHandler > should handle errors from processAndLogFoods
Unhandled error in foodLogHandler: Error: Fitbit API Down
    at C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/backend/test/foodlog.test.ts:302:7
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:919:26
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1244:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1210:10)
    at file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:37
    at Traces.$ (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/vitest@4.0.14_@opentelemetr_6395e7618744bf649428ef839d079ae8/node_modules/vitest/dist/chunks/test.DqQZzsWf.js:234:21)
    at runTest (file:///C:/Users/viv_v/VSCodeWorkspace/public-smart-food-logger/node_modules/.pnpm/@vitest+runner@4.0.14/node_modules/@vitest/runner/dist/index.js:1654:12)

 [32m‚úì[39m test/foodlog.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 17[2mms[22m[39m

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  test/webhookHandler.test.ts > fitbitWebhookHandler > GET request (OAuth callback) > should exchange code for tokens and redirect if state is valid and includes redirectUri
AssertionError: expected "vi.fn()" to be called with arguments: [ 302, ‚Ä¶(1) ]

Number of calls: 0

 ‚ùØ test/webhookHandler.test.ts:193:32
    191|         "testFirebaseUid",
    192|       );
    193|       expect(mockRes.redirect).toHaveBeenCalledWith(
       |                                ^
    194|         302,
    195|         "http://example.com/redirect?uid=testFirebaseUid",


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m7 passed[39m[22m[90m (8)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m99 passed[39m[22m[90m (100)[39m
[2m   Start at [22m 19:04:31
[2m   Duration [22m 619ms[2m (transform 640ms, setup 152ms, import 1.36s, tests 103ms, environment 1ms)[22m

