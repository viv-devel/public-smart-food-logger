name: CI - PR Check

on:
  workflow_dispatch:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    # Removed paths filter to ensure lint/format runs on all PRs

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
      statuses: write
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'shared/**'
              - '.github/**'
            frontend:
              - 'frontend/**'
              - 'shared/**'
              - '.github/**'
            shared:
              - 'shared/**'
              - '.github/**'

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Run ESLint (Fix)
        run: pnpm run lint --fix

      - name: Run Prettier (Write)
        run: pnpm run format

  test-shared:
    needs: [check-changes, code-quality]
    if: ${{ needs.check-changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest
    environment: ci
    steps:
      - uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Test Shared
        run: pnpm --filter shared run test

  test-backend:
    needs: [check-changes, code-quality]
    if: ${{ needs.check-changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    environment: ci
    env:
      FITBIT_CLIENT_ID: ${{ secrets.FITBIT_CLIENT_ID }}
      FITBIT_CLIENT_SECRET: ${{ secrets.FITBIT_CLIENT_SECRET }}
      FITBIT_REDIRECT_URI: ${{ vars.FITBIT_REDIRECT_URI }}
      ENVIRONMENT: ${{ vars.ENVIRONMENT }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Build Shared
        run: pnpm --filter shared run build

      - name: Test Backend with Coverage
        run: |
          echo "## Backend Coverage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pnpm --filter backend run test:coverage | tee backend_coverage.txt
          cat backend_coverage.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage

  test-frontend:
    needs: [check-changes, code-quality]
    if: ${{ needs.check-changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    environment: ci
    env:
      NEXT_PUBLIC_FITBIT_BACKEND_REDIRECT_URI: ${{ vars.NEXT_PUBLIC_FITBIT_BACKEND_REDIRECT_URI }}
      NEXT_PUBLIC_FITBIT_FRONTEND_REDIRECT_URI: ${{ vars.NEXT_PUBLIC_FITBIT_FRONTEND_REDIRECT_URI }}
      NEXT_PUBLIC_PORTAL_URL: ${{ vars.NEXT_PUBLIC_PORTAL_URL }}
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_SITE_KEY }}
      NEXT_PUBLIC_ENVIRONMENT: ci-test
      NEXT_PUBLIC_MOCK_AUTH: "true"
      NEXT_PUBLIC_FITBIT_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_FITBIT_CLIENT_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Build Shared
        run: pnpm --filter shared run build

      # Note: Running E2E tests in CI might require more setup (e.g. installing browsers)
      # For PR checks, we usually run unit/integration tests.
      - name: Test Frontend (Unit)
        run: pnpm --filter frontend run test

      - name: Test Frontend with Coverage
        run: |
          echo "## Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pnpm --filter frontend run test:coverage | tee frontend_coverage.txt
          cat frontend_coverage.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright
        with:
          playwright-browsers-path: ${{ github.workspace }}/.cache/playwright

      - name: Test Frontend (E2E)
        run: pnpm --filter frontend run test:e2e:ci
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.cache/playwright

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: frontend/test/results/playwright-report
          retention-days: 30

      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage
